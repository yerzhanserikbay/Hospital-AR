/*
 * Human Background Manager v-4
 * Built on 12.12.2017 05:08:58 PM
 * (c) 2017 BioDigital, Inc.
 */

!function(a){"use strict";var b,c=/(\s*[\d\.]+\s*,){2,15}\s*[\d\.]+\s*/g,d={colors:null,colorStops:null,gradientType:null},e=["white","black"],f={black:{xray:{color:[.8,.8,.9],glassFactor:.7,murkiness:.8},canvasStyles:{wire:{strokeStyle:"rgb(204, 204, 204)"}}},white:{xray:{color:[0,0,.1],glassFactor:.9,murkiness:.75},canvasStyles:{wire:{strokeStyle:"rgb(153,153,153)"}}}},g={colors:[{},{}],averageColor:{},averageGray:{},gradientType:null},h={},i=function(a){return"undefined"!=typeof a},j=function(){var b=a.document.createEvent("Event");b.initEvent("human.background.set",!0,!0);var c=A();for(var d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);return b},k=function(b){for(var c=0;3>c;c++)if(a.parseFloat(b[c])>1)return!0;return!1},l=function(b,c){var d=a.Math.abs(c-b),e=d/2+a.Math.min(b,c);return e/100},m=function(b){var c=.299*b[0],d=.587*b[1],e=.114*b[2],f=c+d+e;return f=k(b)?a.Math.round(f):a.Math.round(100*f)/100},n=function(b){var c=a.document.createElement("div");c.style.backgroundColor=b,a.document.documentElement.appendChild(c);var d=a.getComputedStyle(c).backgroundColor;return d=d.replace(/\s/g,""),a.document.documentElement.removeChild(c),d},o=function(b){b=b.slice(0,4),3===b.length&&b.push(1);for(var c=0;4>c;c++)b[c]=a.parseFloat(b[c]),b[c]<0&&(b[c]=0),b[c]>255&&(b[c]=255);return b[3]>1&&(b[3]=1),b},p=function(a){var b;if(Array.isArray(a))b=o(a);else if("string"==typeof a){var d=a.match(c);if(d)b=o(d[0].split(","));else{var e=n(a);d=e.match(c),d&&(b=o(d[0].split(",")))}}return b},q=function(){var a=g.colors,b=g.averageColor,c=l(a[0].stop,a[1].stop);b[1]=G(a[0][1],a[1][1],c),b[255]=G(a[0][255],a[1][255],c);var d=g.averageGray;d[1]=m(g.averageColor[1]),d[255]=m(g.averageColor[255])},r=function(){var a=null,b=null,c=g.colors[0][1],d=g.colors[1][1],e=c.concat(d).join("");for(var f in h)if(h.hasOwnProperty(f)&&e===h[f].join("")){a=f;break}var i=g.averageGray[1];return b=.5>i?"black":"white",{custom:a,measured:b}},s=function(b){for(var c=a.document.documentElement,d=c.className.split(" "),f=e.map(function(a){return["bg",a].join("-")}),g=0;g<f.length;g++){var h=d.indexOf(f[g]);h>=0&&d.splice(h,1)}var i=["bg",b.custom||b.measured].join("-");d.push(i),c.className=d.join(" ").trim()},t=!1,u=function(){var c=["-webkit-","-moz-","-ms-","-o-",""],d={expression:/{{\s([a-z0-9]+)\s}}/g,template:"{{ c1 }} {{ s1 }}, {{ c2 }} {{ s2 }}"};d.c1="rgba("+g.colors[0][255].join(",")+")",d.c2="rgba("+g.colors[1][255].join(",")+")",d.s1=g.colors[0].stop+"%",d.s2=g.colors[1].stop+"%";var e=d.template,f=function(a,b){e=e.replace(a,d[b])};d.template.replace(d.expression,f),"radial"===g.gradientType?e="radial-gradient(ellipse at center, "+e+")":"linear"===g.gradientType&&(e="linear-gradient(top, "+e+")");for(var h=0;h<c.length;h++)b.style.backgroundImage=c[h]+e;var i=r();"Human"in a&&w(i),s(i),t||(t=!0,a.setTimeout(function(){b.dispatchEvent(j()),t=!1},0))},v=function(a,b){for(var c,d=[b.custom,b.measured],e=0;e<d.length;e++){for(var g=[d[e]].concat(a.split(".")),h=f,i=0,j=g[i];h.hasOwnProperty(j);)if(h=h[j],i++,j=g[i],i===g.length-1){c=h[j];break}if(c)break}return c},w=function(a){var b=g.colors[0][1].concat(g.colors[1][1]);if(Human.renderer.bg.setBGColor(b),Human.renderer.getScene())try{var c=v("xray.color",a),d=v("xray.glassFactor",a),e=v("xray.murkiness",a),f=v("canvasStyles",a);i(c)&&Human.renderer.setXrayBGColor(c),i(d)&&Human.renderer.setXrayGlassFactor(d),i(e)&&Human.renderer.setXrayMurkiness(e),i(f)&&Human.view.annotations.setCanvasStyles(f)}catch(h){}},x=function(a){var b;if("string"==typeof a)b=a;else if(Array.isArray(a)){b=[];for(var c=0;c<a.length;c++)b[c]=a[c]}else{b={};for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d])}return b},y=function(){return{colors:x(d.colors),colorStops:x(d.colorStops),gradientType:d.gradientType}},z=function(a){a.colors&&(d.colors=a.colors),a.colorStops&&(d.colorStops=a.colorStops),a.gradientType&&(d.gradientType=a.gradientType)},A=function(){return{colors:[{1:x(g.colors[0][1]),255:x(g.colors[0][255]),stop:g.colors[0].stop},{1:x(g.colors[1][1]),255:x(g.colors[1][255]),stop:g.colors[1].stop}],averageColor:{1:x(g.averageColor[1]),255:x(g.averageColor[255])},averageGray:x(g.averageGray),gradientType:g.gradientType}},B=function(a,b){var c=p(b);if(!c)throw new TypeError("Invalid color input.");var d,e,f=F(c);k(c)?(e=c,d=f):(e=f,d=c),g.colors[a][1]=d,g.colors[a][255]=e},C=function(b){var d=[];if("string"==typeof b){var e=b.match(c);e&&(b=e.join(",")),b=b.split(",")}if(Array.isArray(b)){var f=Array.isArray(b[0])&&Array.isArray(b[1]);if(f)d=b;else if(b.length<=2)d=1===b.length?b.concat(b):b;else{var h=a.Math.floor(b.length/2);d=b.length>4?[b.slice(0,h),b.slice(h)]:[b,b]}}for(var i=0;i<g.colors.length;i++)B(i,d[i]);q(),u()},D=function(b){"string"==typeof b&&(b=b.split(","));for(var c=0;c<g.colors.length;c++)g.colors[c].stop=a.parseInt(b[c]);q(),u()},E=function(a){g.gradientType=a,u()},F=function(b){for(var c,d=k(b),e=[],f=0;3>f;f++)c=d?b[f]/255:255*b[f],c=d?a.Math.round(100*c)/100:a.Math.round(c),e.push(c);return 4===b.length&&e.push(b[3]),e},G=function(b,c,d){var e,f,g,h=k(b),i=[];d||(d=.5);for(var j=0;3>j;j++)e=a.Math.pow(b[j],2)*d,f=a.Math.pow(c[j],2)*(1-d),g=a.Math.sqrt(e+f),g=h?a.Math.round(g):a.Math.round(100*g)/100,i.push(g);return 4===b.length&&(g=(b[3]+c[3])/2,g=a.Math.round(100*g)/100,i.push(g)),i},H=!1;a.HumanBackground={element:null,engineProperties:f,init:function(){if(!H){H=!0;var c="[background-color]";if(b=a.document.querySelector(c),!b)throw new Error("Background element not found.");this.element=b;var e=b.getAttribute("background-color"),f=b.getAttribute("background-color-stops"),g=b.getAttribute("background-color-gradient");if(d.colors=d.colors||e,d.colorStops=d.colorStops||f,d.gradientType=d.gradientType||g,!d.colors)throw new Error("Background color not set.");if(!d.colorStops)throw new Error("Background color stops not set.");if(!d.gradientType)throw new Error("Background gradient type not set.");return C(d.colors),D(d.colorStops),E(d.gradientType),b.addEventListener("human.background.config",function(a){C(a.colors),D(a.colorStops),E(a.gradientType)}),this.input.init(),b}},getCustomColor:function(a){var b=h[a];return b&&x(b)},addCustomColors:function(a){for(var b in a)a.hasOwnProperty(b)&&(h[b]=a[b],e.push(b))},synchEngine:w,getDefaults:y,setDefaults:z,getBackgroundData:A,setColors:C,setColorStops:D,setGradientType:E,is255:k,scaleColor:F,averageColors:G,convert:p}}(window),function(a){"use strict";var b=["url","bookmark","content","cookie"],c={},d={},e=!1,f=!1,g=function(b){var c=a.document.createEvent("Event");c.initEvent("human.background.config",!0,!0);for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c},h=function(a){return a.type&&(a.gradientType=a.type,delete a.type),a.interior&&(a.color1=a.interior,delete a.interior),a.exterior&&(a.color2=a.exterior,delete a.exterior),(a.color1||a.color2)&&(a.color1||(a.color1=a.color2),a.color2||(a.color2=a.color1),"string"==typeof a.color1&&(a.color1=a.color1.split(",")),"string"==typeof a.color2&&(a.color2=a.color2.split(",")),a.colors=a.color1.concat(a.color2),delete a.color1,delete a.color2),a},i=function(a){return null!==a&&"object"==typeof a},j=function(a){return i(a)&&0===Object.keys(a).length},k={},l=HumanBackground.input={init:function(){e||("Human"in a&&l.enableContentConfig(),l.buildConfig(),e=!0)},setPriorities:function(a){Array.isArray(a)&&(b=a)},buildConfig:function(){d=HumanBackground.getDefaults();for(var a=b.length-1;a>=0;a--){var e=b[a],f=e[0].toUpperCase()+e.slice(1),i="get"+f+"Config";c[b[a]]=h(this[i]());for(var j in c[b[a]])c[b[a]].hasOwnProperty(j)&&(d[j]=c[b[a]][j])}var k=g(d);return HumanBackground.element.dispatchEvent(k),d},getConfig:function(){return d},getUrlParams:function(){for(var b=a.location.search.replace(/^\?/,""),c=b.split("&"),d={},e=0;e<c.length;e++){var f=c[e].toLowerCase().split("=");d[f[0]]=f[1]}return d},getUrlConfig:function(){var b={},c=this.getUrlParams();if(c.background)b.colors=c.background;else if(c.bgstd){var d=c.bgstd.split(",");if(d.length>3){var e=d.slice(0,d.length/2),f=d.slice(d.length/2);d=f.concat(e)}b.colors=d.join(",")}for(var g in c)if(c.hasOwnProperty(g)&&/^background\.[a-z0-9\-]+$/.test(g)){var h=g.split(".")[1].replace(/-([a-z])/g,function(a){return a[1].toUpperCase()});b[h]=a.decodeURIComponent(c[g])}return b},getBackgroundCookie:function(){var b=a.document.cookie.match(/background=([^;\s]*)/);return b&&b[1]},getCookieConfig:function(){var a={},b=this.getBackgroundCookie();if(b){var c=HumanBackground.getCustomColor(b);a.colors=c?c:b}return a},getContentConfig:function(){var b,c={};if(!("Human"in a))return c;if(Human.timeline.activeRoot&&(b=Human.timeline.activeRoot._nowBranch.background,!b||j(b))){var d=Human.timeline.activeRoot.id;b=Human.modules.modules[d].background}return"string"==typeof b||Array.isArray(b)?c.colors=b:null!==b&&"object"==typeof b&&(c=b),c},getBookmarkConfig:function(){return k},enableContentConfig:function(){if(!f){var a=this.buildConfig.bind(this);Human.events.on("modules.activate.finish",a),Human.events.on("timeline.chapters.activated",a),Human.events.on("bookmarks.restored",function(b){k=b.background?b.background:{},a()}),Human.events.on("modules.activate.start",function(){k={}}),f=!0}}}}(window);